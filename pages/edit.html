<html>
<head>
    <title>Sick Journal: Edit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="manifest" href="../manifest.json" />
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/edit.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../serviceworker.js')
        }
    </script>
</head>
<body>
    
    <main>
        <dialog id="editDialog" data-mode="edit">
            <h2>Edit entry</h2>
            <form method="dialog" class="layout-col2">
                <label for="diagDate">Date:</label>
                <input type="date" name="diagDate" onchange="uiMatchEntryEditDate(this)"/>
                
                <label for="diagMood">Feeling:</label>
                <select name="diagMood">
                    <option value="worse">worse</option>
                    <option value="same">same</option>
                    <option value="better">better</option>
                </select>
                
                <label for="diagSyms">Symptoms:</label>
                <input type="text" name="diagSyms"/>
                
                <label for="diagMeds">Medications:</label>
                <input type="text" name="diagMeds"/>
            </form>
            <div>
                <button onclick="uiSaveEntryEdit()">save<span class="material-symbols-outlined">save</span></button>
                <button id="deleteEntry" onclick="uiDeleteEntry()">delete<span class="material-symbols-outlined">delete</span></button>
                <button onclick="uiCancelEntryEdit()">cancel<span class="material-symbols-outlined">cancel</span></button>
            </div>
        </dialog>
        <section>
            <table>
                <thead>
                    <tr>
                        <th>date</th>
                        <th>summary</th>                        
                    </tr>
                </thead>
                <tbody>
                    <template id="templateEntryItem">
                        <tr data-index="0" onclick="uiShowEntryEdit(this.dataset.index)">
                            <td class="row-date">yyyy-MM-dd</td>
                            <td class="row-summary">feeling {mood} with {symptomn-list} taking {medication-list}</td>                            
                        </tr>
                    </template>
                </tbody>
            </table>
            <button onclick="uiAddEntry()">add<span class="material-symbols-outlined">add</span></button>
        </section>
    </main>
    <nav>
        <button onclick="dbUpdateEvent()">save<span class="material-symbols-outlined">save</span></button>
        <button onclick="dbDeleteEvent()">delete<span class="material-symbols-outlined">delete</span></button>
        <button onclick="uiCancelEdits()">cancel<span class="material-symbols-outlined">cancel</span></button>
    </nav>
    
   <script>
        const dbReq = window.indexedDB.open('sickjournaldb', 2);
        var dbCurrentEvent = null
        var dbCurrentEventEntryIndex = -1
        
        dbReq.onsuccess = (event) => {
            console.log('Successfully opened DB', dbReq.result)
            uiUpdate()
        }

        dbReq.onerror = (event) => {
            console.log('Failed to open DB', dbReq.error)
        }

        dbReq.onupgradeneeded = (event) => {
            const db = event.target.result;            
            const store = db.createObjectStore('sickevent', {keyPath: 'id', autoIncrement: true})
            
            console.log('Successfully created store', store)
        }
    </script>
    
    <script>
        
        function dbUpdateEvent() {
            if (confirm('Save all edits?') == false) {
                return
            }
            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readwrite')
            const store = tr.objectStore('sickevent')
            store.put(dbCurrentEvent)
            window.location = '../pages/history.html'
        }
        
        function getUrlParams() {    
            var vars = {};  
            var parts = window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                vars[key] = value;
            });
            return vars;
        }
        
        function dbDeleteEvent() {
            if (confirm('Delete entire event and all entries?') == false) {
                return
            }
            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readwrite')            
            const store = tr.objectStore('sickevent')            
            store.delete(dbCurrentEvent.id)
            window.location = '../pages/history.html'
        }
                
        function uiUpdate() {
            var urlparams = getUrlParams();
            var dbId = parseInt(urlparams['id'])

            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readonly')
            const store = tr.objectStore('sickevent')
            store.get(dbId).onsuccess = (event) => {
                dbCurrentEvent = event.target.result                
                uiUpdateEntries(dbCurrentEvent.entries)
            }
        }
        
        function uiUpdateEntries(items) {

            var templateItem = document.getElementById('templateEntryItem')
            var templateContainer = templateItem.parentElement
            
            while(templateContainer.lastElementChild.hasAttribute('data-index')) {
                templateContainer.removeChild(templateContainer.lastChild)
            }
            
            for (let i = 0; i < items.length; i++) {                
                var item = templateItem.content.cloneNode(true)
                var mood = items[i].feeling
                var syms = items[i].symptoms.join(',')
                var meds = items[i].medications.join(',')
                item.querySelector('tr').dataset.index = i
                item.querySelector('.row-date').innerText = items[i].date.toDateString()
                item.querySelector('.row-summary').innerText = `feeling ${mood}${syms.length > 0 ? ', with symptoms: ' : ''}${syms}${meds.length > 0 ? '. taking: ' : ''}${meds}.`
                templateContainer.appendChild(item);
            }
        }
        
        function uiCancelEdits() {            
            window.location = '../pages/history.html'
        }
        
        function uiShowEntryEdit(index, withDate = null) {
            dbCurrentEventEntryIndex = index
            
            var diag = document.getElementById('editDialog')
            var diagDate = diag.querySelector('[name="diagDate"]')
            var diagMood = diag.querySelector('[name="diagMood"]')
            var diagSyms = diag.querySelector('[name="diagSyms"]')
            var diagMeds = diag.querySelector('[name="diagMeds"]')
            var diagDel = document.getElementById('deleteEntry')
            
            diag.querySelector('h2').innerText = diag.dataset.mode.endsWith('edit') ? 'edit entry' : 'add entry'
            
            if (dbCurrentEventEntryIndex <= 0) {
                diagMood.disabled = true
                diagDel.style.display = 'none'
            }
            else {
                diagMood.disabled = false
                diagDel.style.display = ''
            }
            
            if (dbCurrentEvent.entries.length == dbCurrentEventEntryIndex) {
                diagDel.style.display = 'none'
                var first = dbCurrentEvent.entries[0].date
                                
                //TODO: min not supported in ios
                diagDate.setAttribute('min', first.toISOString().split('T')[0])
                diagDate.removeAttribute('disabled')
                
                diagMood.querySelectorAll('option').forEach(mood => {mood.selected = false})
                diagMood.querySelectorAll('option')[1].selected = true
                diagSyms.value = ''
                diagMeds.value = ''                
            }            
            else {
                var entry = dbCurrentEvent.entries[dbCurrentEventEntryIndex]
                diagDate.valueAsDate = (withDate == null) ? entry.date : withDate
                diagMood.querySelectorAll('option').forEach(mood => {mood.selected = false})
                diagMood.querySelectorAll(`option[value="${entry.feeling}"]`).selected = true
                diagSyms.value = entry.symptoms.join()
                diagMeds.value = entry.medications.join()                
            }
            
            if (diag.open == false) {
                diag.showModal()
            }
        }
        
        function uiCancelEntryEdit() {
            var diag = document.getElementById('editDialog')
            diag.dataset.mode = "edit"
            diag.close()
        }
        
        function uiMatchEntryEditDate(elem) {
            var diag = document.getElementById('editDialog')
            var selDate = new Date(elem.value.replaceAll('-', '/'))
            
            var hasMatch = false
            dbCurrentEvent.entries.forEach((entry, index) => {                
                if (hasMatch == false && entry.date.getTime() == selDate.getTime()) {
                    dbCurrentEventEntryIndex = index
                    hasMatch = true
                    if (diag.dataset.mode == 'add') {
                        diag.dataset.mode += '/edit'
                    }                
                }                
            })
            
            if (hasMatch == false && diag.dataset.mode.startsWith('add')) {
                dbCurrentEventEntryIndex = dbCurrentEvent.entries.length
                diag.dataset.mode = 'add'
                selDate = null
            }
                        
            uiShowEntryEdit(dbCurrentEventEntryIndex, selDate)
        }
        
        function uiSaveEntryEdit() {
            if (dbCurrentEvent.entries.length == dbCurrentEventEntryIndex) {
                dbCurrentEvent.entries.push({
                    date: new Date(),
                    feeling: 'same',
                    symptoms: [],
                    medications: []
                })
            }
            var entry = dbCurrentEvent.entries[dbCurrentEventEntryIndex]            
            var diag = document.getElementById('editDialog')
            var diagDate = diag.querySelector('[name="diagDate"]')
            var diagMood = diag.querySelector('[name="diagMood"]')
            var diagSyms = diag.querySelector('[name="diagSyms"]')
            var diagMeds = diag.querySelector('[name="diagMeds"]')
            
            diag.dataset.mode = "edit"
            entry.date = new Date(diagDate.value.replaceAll('-', '/'))
            entry.feeling = diagMood.value
            entry.symptoms = diagSyms.value.split(',')
            entry.medications = diagMeds.value.split(',')
            
            dbCurrentEvent.entries.sort((a,b)=>a.date.getTime()-b.date.getTime());
            dbCurrentEvent.entries[0].feeling = 'worse'
            
            uiUpdateEntries(dbCurrentEvent.entries)
            
            diag.close()
        }
        
        function uiDeleteEntry() {
            if (confirm('Delete this entire entry?') == false) {
                return
            }
            dbCurrentEvent.entries.splice(dbCurrentEventEntryIndex, 1)
            uiUpdateEntries(dbCurrentEvent.entries)
            var diag = document.getElementById('editDialog')
            diag.dataset.mode = "edit"
            diag.close()
        }
        
        function uiAddEntry() {
            var diag = document.getElementById('editDialog')
            diag.dataset.mode = "add"
            diag.querySelector('[name="diagDate"]').value = ''
            uiShowEntryEdit(dbCurrentEvent.entries.length)
        }
        
    </script>
</body>
</html>