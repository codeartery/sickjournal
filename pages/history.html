<html>
<head>
    <title>Sick Journal: History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="manifest" href="../manifest.json" />
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/history.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../serviceworker.js')
        }
    </script>
</head>
<body>
    
    <main>
        <header class="layout layout-col2 layout-center">
            <span>view <input type="button" value="history"/></span>            
            <span>sort <input type="button" value="newest" /></span>
        </header>
        <dialog id="newDialog">
            <h2>new entry</h2>
            <form method="dialog" class="layout-col2">
                <label for="diagDate">Date:</label>
                <input type="date" name="diagDate"/>
            </form>
            <div>
                <button onclick="dbSaveNewEvent()">save<span class="material-symbols-outlined">save</span></button>
                <button onclick="uiCancelNewEvent()">cancel<span class="material-symbols-outlined">cancel</span></button>
            </div>
        </dialog>
        <section class="ph2 layout layout-gap">
            <template id="templateHistoryItem">
                <form action="edit.html" method="GET" class="highlighted-rows layout layout-col2 layout-center">                    
                    <div class="row-header">
                        <div class="row-label">x day sickness</div>
                        <div class="row-date">yyyy-mm-dd</div>
                    </div>
                    <div class="row-image">
                        <input type="text" name="id" value="-1" hidden />
                        <div class="material-symbols-outlined" onclick="this.parentElement.parentElement.submit();">edit</div>
                    </div>
                </form>
            </template>            
        </section>
        <button onclick="uiAddNewEvent()">add<span class="material-symbols-outlined">add</span></button>
    </main>
    <nav>
        <a href="../index.html"><span class="material-symbols-outlined">thermostat</span></a>
        <a href="../pages/history.html" class="nav-active"><span class="material-symbols-outlined">auto_stories</span></a>
        <a href="../pages/settings.html"><span class="material-symbols-outlined">settings</span></a>
    </nav>
    
    <script>
        const dbReq = window.indexedDB.open('sickjournaldb', 2);
        var dbCurrentEvent = null
        var dbCurrentEventEntryIndex = -1
        
        dbReq.onsuccess = (event) => {
            console.log('Successfully opened DB', dbReq.result)
            uiUpdate()
        }

        dbReq.onerror = (event) => {
            console.log('Failed to open DB', dbReq.error)
        }

        dbReq.onupgradeneeded = (event) => {
            const db = event.target.result;            
            const store = db.createObjectStore('sickevent', {keyPath: 'id', autoIncrement: true})
            
            console.log('Successfully created store', store)
        }
    </script>
    
    <script>
        
        function getUrlParams() {    
            var vars = {};  
            var parts = window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                vars[key] = value;
            });
            return vars;
        }
        
        function uiUpdate() {            
            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readonly')
            const store = tr.objectStore('sickevent')
            store.getAll().onsuccess = (event) => {
                const rows = event.target.result                
                uiUpdateHistory(rows)     
            }
            
            const urlparams = getUrlParams();
            if ('old' in urlparams) {
                uiAddNewEvent()
            }
        }
        
        function uiUpdateHistory(items) {

            var templateItem = document.getElementById('templateHistoryItem')
            var templateContainer = templateItem.parentElement
            
            while(templateContainer.lastElementChild.hasAttribute('action')) {
                templateContainer.removeChild(templateContainer.lastChild)
            }
            
            for (let i = 0; i < items.length; i++) {                
                var item = templateItem.content.cloneNode(true)
                item.querySelector('input').value = items[i].id
                item.querySelector('.row-label').innerText = (items[i].entries[items[i].entries.length - 1].date.getTime() - items[i].entries[0].date.getTime()) / (1000 * 3600 * 24) + ' day sickness';
                item.querySelector('.row-date').innerText = items[i].entries[0].date.toDateString();
                templateContainer.appendChild(item);
            }
        }
        
        function uiAddNewEvent() {
            var diag = document.getElementById('newDialog')
            if (diag.open == false) {
                diag.showModal()
            }
        }
        
        function uiCancelNewEvent() {
            var diag = document.getElementById('newDialog')
            diag.close()
        }
        
        function dbSaveNewEvent() {
            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readwrite')            
            const store = tr.objectStore('sickevent')
            
            var diag = document.getElementById('newDialog')
            var diagDate = diag.querySelector('[name="diagDate"]')            
            var eventDate = new Date(diagDate.value.replaceAll('-', '/'))
            
            if (isNaN(eventDate.getTime())) {
                alert('Invalid date selected!')
                return
            }
            
            const store_add = store.add({
                better: true,
                entries: [{
                    date: eventDate,
                    feeling: 'worse',
                    symptoms: [],
                    medications: []
                }]
            })
            
            store_add.onsuccess = (event) => {
                window.location.replace('../pages/edit.html?id='+event.target.result)
            }
            
            diag.close()
        }
        
    </script>
   
</body>
</html>