<html>
<head>
    <title>Sick Journal: Current</title>
    <link rel="manifest" href="./manifest.json" />
    <link rel="stylesheet" href="./styles/global.css" />
    <link rel="stylesheet" href="./styles/index.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="apple-touch-icon" href="/icons/ios.png">
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./serviceworker.js')
        }
    </script>
    
</head>
<body>
    
    <main>
        <header>
            <span class="days-sick-label">Day </span><span class="days-sick-value" id="daysSickValue">0</span>
            <span class="last-sick">
                <span class="last-sick-label">Last sickness: </span><span class="last-sick-value" id="lastSickValue"></span>
            </span>
        </header>
        <section id="goodUI">
            <div class="layout layout-row2 layout-center">
                <div class="layout layout-row2 layout-center">
                    <span class="mood-image material-symbols-outlined">sentiment_very_satisfied</span>
                    <span class="mood-label">sick free!</span>
                </div>
                <div class="p1">
                    <div class="layout layout-col2 layout-gap">
                        <input type="button" name="old" value="i was sick" />
                        <input type="button" name="new" value="i feel sick" onclick="dbCreateEvent()" />
                    </div>
                </div>
            </div>
        </section>
        
        <section id="sickUI" class="p2">
            <div class="container">
                <div class="layout-flex"> 
                    <div data-mood="worse" class="layout layout-row2 layout-center mood" onclick="dbUpdateMood(this)">
                        <span class="mood-image material-symbols-outlined">sentiment_dissatisfied</span>
                        <span class="mood-label">worse</span>
                    </div>
                    <div data-mood="same" class="layout layout-row2 layout-center mood" onclick="dbUpdateMood(this)">
                        <span class="mood-image material-symbols-outlined">sentiment_neutral</span>
                        <span class="mood-label">same</span>
                    </div>
                    <div data-mood="better" class="layout layout-row2 layout-center mood" onclick="dbUpdateMood(this)">
                        <span class="mood-image material-symbols-outlined">sentiment_satisfied</span>
                        <span class="mood-label">better</span>
                    </div>
                </div>                
                <div class="container pt2">
                    <div class="layout layout-col2 layout-gap">
                        <input type="button" name="cancel" value="False alarm" onclick="dbCancelEvent()" />
                        <input type="button" name="save" value="All better" onclick="dbCompleteEvent()"  />
                    </div>
                </div>
            </div>
            
            <div class="p1 pt2">
                <div class="lined-rows layout layout-col2 layout-center">
                    <span class="row-header">symptoms</span>
                    <span class="row-image material-symbols-outlined" onclick="dbAddSymptom()">add</span>
                </div>                
                <template id="templateSymItem">
                    <div data-index="0" class="lined-rows layout layout-col2 layout-center">
                       <span class="row-label">{name}</span>
                       <span class="row-image material-symbols-outlined" onclick="dbDeleteSymptom(this)">delete</span>
                    </div>
                </template>
               
            </div>
            
            <div class="p1 pt2">
                <div class="lined-rows layout layout-col2 layout-center">
                    <span class="row-header">medications</span>
                    <span class="row-image material-symbols-outlined" onclick="dbAddMedication()">add</span>
                </div>
                <template id="templateMedItem">
                    <div data-index="0" class="lined-rows layout layout-col2 layout-center">
                       <span class="row-label">{name}</span>
                       <span class="row-image material-symbols-outlined" onclick="dbDeleteMedication(this)">delete</span>
                   </div>
               </template>
           </div>
        </section>
    </main>
    <nav>
        <a href="./index.html" class="nav-active"><span class="material-symbols-outlined">thermostat</span></a>
        <a href="./pages/history.html"><span class="material-symbols-outlined">auto_stories</span></a>
        <a href="./pages/settings.html"><span class="material-symbols-outlined">settings</span></a>
    </nav>
   
    <script>
        const dbReq = window.indexedDB.open('sickjournaldb', 2);
        var dbCurrentEvent = null
        var dbCurrentEventEntryIndex = -1
        
        dbReq.onsuccess = (event) => {
            console.log('Successfully opened DB', dbReq.result)
            uiUpdate()
        }

        dbReq.onerror = (event) => {
            console.log('Failed to open DB', dbReq.error)
        }

        dbReq.onupgradeneeded = (event) => {
            const db = event.target.result;            
            const store = db.createObjectStore('sickevent', {keyPath: 'id', autoIncrement: true})
            
            console.log('Successfully created store', store)
        }
    </script>
    
    <script>
        
        function dbCreateEvent() {
            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readwrite')
            
            const store = tr.objectStore('sickevent')
            
            /*//note: clear database
            store.getAll().onsuccess = (event) => {
                event.target.result.forEach(item => {store.delete(item.id)})
            }
            */
            
            const today = new Date()
            today.setHours(0,0,0,0)
            
            const store_add = store.add({
                better: false,
                entries: [{
                    date: today,
                    feeling: 'worse',
                    symptoms: [],
                    medications: []
                }]
            })
            
            store_add.onsuccess = (event) => {
                uiUpdate();                
            }
        }
        
        function dbUpdateEvent() {            
            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readwrite')
            const store = tr.objectStore('sickevent')
            store.put(dbCurrentEvent)
        }
        
        function dbCancelEvent() {            
            if (confirm('This will delete this sick event.') == false) {
                return
            }            
            const db = dbReq.result;
            const tr = db.transaction(db.objectStoreNames, 'readwrite')            
            const store = tr.objectStore('sickevent')            
            store.delete(dbCurrentEvent.id)
            uiUpdate()
        }
        
        function dbCompleteEvent() {
            if (confirm('This will stop this sick event.') == false) {
                return
            }          
            dbCurrentEvent.better = true
            dbUpdateEvent()
            uiUpdate()
        }
        
        function dbUpdateMood(item) {            
            dbCurrentEvent.entries[dbCurrentEventEntryIndex].feeling = item.dataset.mood
            dbUpdateEvent()
            uiUpdateMoods()            
        }
        
        function dbAddSymptom() {            
            var userInput = prompt('New Symptom:')
            if (userInput.length > 0) {                
                dbCurrentEvent.entries[dbCurrentEventEntryIndex].symptoms.push(userInput)
                dbUpdateEvent()
                uiUpdateSymptoms()            
            }
        }
        
        function dbDeleteSymptom(item) {
            dbCurrentEvent.entries[dbCurrentEventEntryIndex].symptoms.splice(item.parentElement.dataset.index, 1)
            dbUpdateEvent()
            uiUpdateSymptoms()
        }
        
        function dbAddMedication() {            
            var userInput = prompt('New Medication:')
            if (userInput.length > 0) {                
                dbCurrentEvent.entries[dbCurrentEventEntryIndex].medications.push(userInput)
                dbUpdateEvent()
                uiUpdateMedications()            
            }
        }
        
        function dbDeleteMedication(item) {
            dbCurrentEvent.entries[dbCurrentEventEntryIndex].medications.splice(item.parentElement.dataset.index, 1)            
            dbUpdateEvent()
            uiUpdateMedications()
        }
        
        function dbGetEntryAsync(forDate) {            
            return new Promise((resolve, reject) => {                
                const db = dbReq.result;
                const tr = db.transaction(db.objectStoreNames, 'readonly')
                const store = tr.objectStore('sickevent')
                store.getAll().onsuccess = (event) => {
                    const rows = event.target.result
                    var found = false
                    rows.forEach(row => {
                        row.entries.forEach((entry, index) => {                            
                            if (entry.date.getTime() == forDate.getTime() && row.better == false) {
                                found = true
                                resolve({dbEvent: row, dbEntryIndex: index})
                            }
                        })
                        if (found == false && row.better == false) {
                            found = true
                            var today = new Date()
                            today.setHours(0,0,0,0)
                            row.entries.push({
                                date: today,
                                feeling: 'same',
                                symptoms: [],
                                medications: []
                            })
                            resolve({dbEvent: row, dbEntryIndex: row.entries.length - 1})
                        }
                    })
                    if (found == false) {
                        if (rows.length > 0) {
                            var last = rows[rows.length - 1]                          
                            resolve({dbEvent: last, dbEntryIndex: 0})
                        }
                        else {                        
                            reject()
                        }
                    }
                }
            })
        }
        
        function uiUpdate() {
            
            const today = new Date()
            today.setHours(0,0,0,0)
            
            dbGetEntryAsync(today)
                .then((result) => {
                    dbCurrentEvent = result.dbEvent
                    dbCurrentEventEntryIndex = result.dbEntryIndex
                    
                    uiUpdateDays()
                    
                    if (dbCurrentEvent.better == true) {
                        dbCurrentEvent = null
                        dbCurrentEventEntryIndex = -1
                        document.getElementById('goodUI').style.display = 'block'
                        document.getElementById('sickUI').style.display = 'none'
                        return
                    }
                    
                    uiUpdateMoods()
                    uiUpdateSymptoms()
                    uiUpdateMedications()
                                        
                    document.getElementById('goodUI').style.display = 'none'
                    document.getElementById('sickUI').style.display = 'block'
                })
                .catch(() => {
                    dbCurrentEvent = null
                    dbCurrentEventEntryIndex = -1
                    document.getElementById('goodUI').style.display = 'block'
                    document.getElementById('sickUI').style.display = 'none'
                })
                
        }
        
        function uiUpdateDays() {
            
            var first = dbCurrentEvent.entries[0].date
            var today = new Date()
            today.setHours(0,0,0,0)
            var days = (today.getTime() - first.getTime()) / (1000 * 3600 * 24)
            document.getElementById('lastSickValue').innerText = first.toDateString()
            
            var daysSickElem = document.getElementById('daysSickValue')
            daysSickElem.innerText = days
            daysSickElem.classList.remove('text-worse')
            daysSickElem.classList.remove('text-better')
            daysSickElem.classList.add('text-' + (dbCurrentEvent.better ? 'better': 'worse'))
            
        }
        
        function uiUpdateMoods() {
            
            var dataMoods = document.querySelectorAll('#sickUI [data-mood]')
            var entry = dbCurrentEvent.entries[dbCurrentEventEntryIndex]
            
            dataMoods.forEach(mood => {
                mood.classList.remove('mood-active')
                
                if (mood.dataset.mood == entry.feeling) {
                    mood.classList.add('mood-active')                    
                }
                else if (dbCurrentEventEntryIndex <= 0) {
                    mood.style.display = 'none';                
                }
            })
            
        }
        
        function uiUpdateSymptoms() {

            var templateItem = document.getElementById('templateSymItem')
            var templateContainer = templateItem.parentElement
            
            while(templateContainer.lastElementChild.hasAttribute('data-index')) {
                templateContainer.removeChild(templateContainer.lastChild)
            }
            
            var items = dbCurrentEvent.entries[dbCurrentEventEntryIndex].symptoms
            
            for (let i = 0; i < items.length; i++) {                
                var item = templateItem.content.cloneNode(true)
                item.querySelector('div').dataset.index = i
                item.querySelector('.row-label').innerText = items[i];
                templateContainer.appendChild(item);
            }
        }
        
        function uiUpdateMedications() {

            var templateItem = document.getElementById('templateMedItem')
            var templateContainer = templateItem.parentElement
            
            while(templateContainer.lastElementChild.hasAttribute('data-index')) {
                templateContainer.removeChild(templateContainer.lastChild)
            }
            
            var items = dbCurrentEvent.entries[dbCurrentEventEntryIndex].medications
            
            for (let i = 0; i < items.length; i++) {                
                var item = templateItem.content.cloneNode(true)
                item.querySelector('div').dataset.index = i
                item.querySelector('.row-label').innerText = items[i];
                templateContainer.appendChild(item);
            }
        }
        
    </script>
    
</body>
</html>